<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#CC785C">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Ø£Ø³Ø¹Ø§Ø±">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<title>ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø¯Ù‰</title>
<style>
  :root {
    --cream:    #FAF7F4;
    --cream-2:  #F2EDE8;
    --ink:      #1C1917;
    --ink-2:    #44403C;
    --ink-3:    #78716C;
    --coral:    #CC785C;
    --coral-d:  #B5633F;
    --coral-l:  #F0C4B0;
    --border:   #E5DDD6;
    --green:    #3D7A5C;
    --green-l:  #C9E8D9;
    --shadow:   0 1px 3px rgba(28,25,23,.08), 0 4px 16px rgba(28,25,23,.06);
    --shadow-sm:0 1px 2px rgba(28,25,23,.06);
    --radius:   16px;
    --radius-sm:10px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'IBM Plex Sans Arabic', sans-serif;
    background: var(--cream);
    color: var(--ink);
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 12px 40px;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    width: 100%;
    max-width: 480px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
    padding: 0;
    gap: 8px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
    flex-shrink: 1;
  }

  .logo-mark {
    width: 46px; height: 46px;
    background: var(--coral);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; color: white; line-height: 1;
    flex-shrink: 0;
  }

  .logo-text {
    font-size: 22px;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: -0.02em;
    white-space: nowrap;
  }

  .date-badge {
    font-size: 15px;
    font-weight: 700;
    color: var(--ink-2);
    background: var(--cream-2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 7px 14px;
    font-family: 'DM Mono', monospace;
    white-space: nowrap;
    flex-shrink: 0;
  }

  /* â”€â”€ Card â”€â”€ */
  .card {
    width: 100%;
    max-width: 480px;
    background: white;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  /* â”€â”€ Customer Section â”€â”€ */
  .customer-section {
    padding: 18px 16px 16px;
    border-bottom: 1px solid var(--cream-2);
    background: var(--cream);
  }

  .section-label {
    font-size: 16px;
    font-weight: 700;
    color: var(--ink-2);
    letter-spacing: .02em;
    margin-bottom: 10px;
  }

  .customer-input {
    width: 100%;
    min-width: 0;
    background: white;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px 14px;
    font-family: 'IBM Plex Sans Arabic', sans-serif;
    font-size: 17px;
    font-weight: 600;
    color: var(--ink);
    outline: none;
    transition: border-color .2s;
    text-align: right;
    direction: rtl;
  }

  .customer-input::placeholder { color: var(--ink-3); }

  .customer-input:focus {
    border-color: var(--coral);
    box-shadow: 0 0 0 3px rgba(204,120,92,.12);
  }

  .customer-field {
    margin-bottom: 12px;
  }

  .customer-field:last-child {
    margin-bottom: 0;
  }

  /* â”€â”€ Total Display â”€â”€ */
  .total-section {
    padding: 32px 20px 24px;
    text-align: center;
    border-bottom: 1px solid var(--cream-2);
    position: relative;
  }

  .total-label {
    font-size: 17px;
    font-weight: 700;
    color: var(--ink-2);
    letter-spacing: .02em;
    margin-bottom: 10px;
  }

  .total-value {
    font-size: clamp(56px, 18vw, 96px);
    font-weight: 700;
    color: var(--green);
    line-height: 1;
    letter-spacing: -0.03em;
    transition: all .3s cubic-bezier(.34,1.56,.64,1);
    font-family: 'DM Mono', monospace;
    word-break: break-all;
  }

  .total-value.bump {
    transform: scale(1.06);
    color: var(--coral);
  }

  .count-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-top: 12px;
    font-size: 17px;
    font-weight: 600;
    color: var(--ink-2);
    background: var(--cream-2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 7px 18px;
  }

  .count-pill strong {
    font-weight: 700;
    color: var(--ink);
    font-family: 'DM Mono', monospace;
  }

  /* â”€â”€ Price Input Section â”€â”€ */
  .input-section {
    padding: 20px 16px;
    border-bottom: 1px solid var(--cream-2);
  }

  .price-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .price-input {
    width: 100%;
    min-width: 0;
    background: var(--cream);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 18px 14px;
    font-family: 'DM Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    color: var(--ink);
    outline: none;
    transition: border-color .2s, box-shadow .2s;
    text-align: center;
    direction: ltr;
  }

  .price-input::placeholder {
    color: var(--ink-3);
    font-size: 18px;
    font-weight: 400;
    font-family: 'IBM Plex Sans Arabic', sans-serif;
  }

  .price-input:focus {
    border-color: var(--coral);
    background: white;
    box-shadow: 0 0 0 3px rgba(204,120,92,.12);
  }

  /* Remove number input arrows */
  .price-input::-webkit-outer-spin-button,
  .price-input::-webkit-inner-spin-button { -webkit-appearance: none; }
  .price-input[type=number] { -moz-appearance: textfield; }

  .add-btn {
    width: 100%;
    height: 58px;
    background: var(--coral);
    border: none;
    border-radius: var(--radius-sm);
    color: white;
    font-size: 30px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background .18s, transform .12s;
    flex-shrink: 0;
    line-height: 1;
  }

  .add-btn:hover { background: var(--coral-d); }
  .add-btn:active { transform: scale(.93); }

  /* â”€â”€ Items list â”€â”€ */
  .items-section {
    padding: 14px 20px 10px;
    max-height: 220px;
    overflow-y: auto;
    border-bottom: 1px solid var(--cream-2);
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .items-section:empty { display: none; }

  .item-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--cream-2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 6px 12px 6px 8px;
    font-size: 17px;
    font-weight: 600;
    color: var(--ink-2);
    margin: 4px 4px;
    font-family: 'DM Mono', monospace;
    animation: chip-in .25s cubic-bezier(.34,1.56,.64,1);
  }

  @keyframes chip-in {
    from { opacity:0; transform: scale(.7); }
    to   { opacity:1; transform: scale(1); }
  }

  .chip-remove {
    width: 22px; height: 22px;
    background: var(--border);
    border: none; border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    color: var(--ink-3);
    display: flex; align-items: center; justify-content: center;
    transition: background .15s;
    flex-shrink: 0;
  }
  .chip-remove:hover { background: var(--coral-l); color: var(--coral-d); }

  /* â”€â”€ Actions â”€â”€ */
  .actions {
    padding: 16px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .btn {
    border: none;
    border-radius: var(--radius-sm);
    padding: 16px 10px;
    font-family: 'IBM Plex Sans Arabic', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: background .18s, transform .12s, box-shadow .18s;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    letter-spacing: -0.01em;
    min-height: 56px;
  }

  .btn:active { transform: scale(.96); }

  .btn-primary {
    background: var(--coral);
    color: white;
  }
  .btn-primary:hover { background: var(--coral-d); }

  .btn-secondary {
    background: var(--cream-2);
    color: var(--ink-2);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { background: var(--border); }

  .btn-danger {
    background: white;
    color: #C0392B;
    border: 1px solid #F5C6C2;
  }
  .btn-danger:hover { background: #FEF0EE; }

  .btn-full { grid-column: 1 / -1; }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--ink);
    color: white;
    padding: 13px 24px;
    border-radius: 20px;
    font-size: 17px;
    font-weight: 600;
    pointer-events: none;
    transition: transform .35s cubic-bezier(.34,1.56,.64,1), opacity .35s;
    opacity: 0;
    white-space: nowrap;
    z-index: 100;
  }
  .toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  /* â”€â”€ PWA install banner â”€â”€ */
  #install-banner {
    display: none;
    width: 100%;
    max-width: 480px;
    margin-bottom: 14px;
    background: var(--coral-l);
    border: 1px solid var(--coral);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    color: var(--coral-d);
    font-weight: 500;
  }

  #install-banner.visible { display: flex; }

  #install-btn {
    margin-right: auto;
    background: var(--coral);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 7px 14px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'IBM Plex Sans Arabic', sans-serif;
  }

  #dismiss-banner {
    background: none; border: none;
    color: var(--coral-d); font-size: 18px;
    cursor: pointer; line-height: 1; padding: 0 2px;
  }

  /* â”€â”€ Today's customers dropdown â”€â”€ */
  .today-section {
    width: 100%;
    max-width: 480px;
    margin-bottom: 12px;
  }

  .today-label {
    font-size: 16px;
    font-weight: 700;
    color: var(--ink-2);
    letter-spacing: .02em;
    margin-bottom: 8px;
    padding: 0 2px;
  }

  .today-select {
    width: 100%;
    min-width: 0;
    background: white;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px 14px;
    font-family: 'IBM Plex Sans Arabic', sans-serif;
    font-size: 17px;
    font-weight: 600;
    color: var(--ink);
    outline: none;
    cursor: pointer;
    transition: border-color .2s, box-shadow .2s;
    text-align: right;
    direction: rtl;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%2378716C' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 14px center;
    box-shadow: var(--shadow-sm);
  }

  .today-select:focus {
    border-color: var(--coral);
    box-shadow: 0 0 0 3px rgba(204,120,92,.12);
  }

  .today-select:disabled {
    opacity: .5;
    cursor: default;
  }
</style>
</head>
<body>

<!-- Install Banner -->
<div id="install-banner">
  <span>ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</span>
  <button id="install-btn">ØªØ«Ø¨ÙŠØª</button>
  <button id="dismiss-banner">âœ•</button>
</div>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-mark">ï¼‹</div>
    <span class="logo-text">Ù‡Ø¯Ù‰</span>
  </div>
  <div class="date-badge" id="dateDisplay">â€”</div>
</header>

<!-- Today's Customers Dropdown -->
<div class="today-section">
  <div class="today-label">Ø²Ø¨Ø§Ø¦Ù† Ø§Ù„ÙŠÙˆÙ…</div>
  <select id="todaySelect" class="today-select" onchange="loadFromDropdown()">
    <option value="">â€” Ø§Ø®ØªØ± Ø²Ø¨ÙˆÙ† â€”</option>
  </select>
</div>

<!-- Main Card -->
<div class="card">

  <!-- Customer -->
  <div class="customer-section">
    <div class="section-label">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†</div>
    <div class="customer-field">
      <input type="text" id="customerName" class="customer-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†â€¦">
    </div>
    <div class="customer-field">
      <input type="tel" id="customerPhone" class="customer-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙâ€¦" inputmode="tel">
    </div>
    <div class="customer-field">
      <input type="text" id="customerAddress" class="customer-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø²Ø¨ÙˆÙ†â€¦">
    </div>
  </div>

  <!-- Total -->
  <div class="total-section">
    <div class="total-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
    <div id="total" class="total-value">0</div>
    <div class="count-pill">
      Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ‚Ø±Ø§Øª: <strong id="count">0</strong>
    </div>
  </div>

  <!-- Price Entry -->
  <div class="input-section">
    <div class="section-label" style="margin-bottom:12px;">Ø¥Ø¶Ø§ÙØ© Ø³Ø¹Ø±</div>
    <div class="price-row">
      <button class="add-btn" onclick="addPrice()" title="Ø£Ø¶Ù">ï¼‹</button>
      <input type="number" id="priceInput" class="price-input" placeholder="0.00" inputmode="decimal" step="0.01" min="0">
    </div>
  </div>

  <!-- Items chips -->
  <div class="items-section" id="itemsList"></div>

  <!-- Actions -->
  <div class="actions">
    <button class="btn btn-secondary" onclick="newCustomer()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.51"/></svg>
      Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯
    </button>
    <button class="btn btn-secondary" onclick="exportJSON()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Ø®Ø²Ù†
    </button>
    <button class="btn btn-secondary" onclick="importJSON()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      ÙØªØ­ Ù…Ù„Ù
    </button>
    <button class="btn btn-danger" onclick="clearAll()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
      Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
    </button>
  </div>

</div>

<!-- Hidden file input -->
<input type="file" id="fileInput" style="display:none" accept=".json">

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let items = [];
let total = 0;
let todayKey = new Date().toISOString().slice(0, 10);          // "YYYY-MM-DD"
let currentDate = new Date().toLocaleDateString('ar-IQ');
let activeIndex = -1;   // index in today's archive array; -1 = unsaved new customer

const priceInput = document.getElementById('priceInput');
const totalEl    = document.getElementById('total');
const countEl    = document.getElementById('count');
const listEl     = document.getElementById('itemsList');
const todaySelect = document.getElementById('todaySelect');

// â”€â”€ Archive helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getArchive() {
  try { return JSON.parse(localStorage.getItem('salesArchive') || '{}'); } catch(e) { return {}; }
}

function saveArchive(archive) {
  try { localStorage.setItem('salesArchive', JSON.stringify(archive)); } catch(e) {}
}

function getTodayList() {
  return getArchive()[todayKey] || [];
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('dateDisplay').innerText = currentDate;
initLoad();

// â”€â”€ Keyboard shortcut: Enter to add â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
priceInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') addPrice();
});

// â”€â”€ Load on startup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initLoad() {
  const list = getTodayList();
  if (list.length > 0) {
    activeIndex = list.length - 1;
    applyCustomerData(list[activeIndex]);
  }
  refreshDropdown();
}

function applyCustomerData(data) {
  items = data.items || [];
  total = data.total || 0;
  currentDate = data.date || currentDate;
  document.getElementById('customerName').value    = data.customerName || '';
  document.getElementById('customerPhone').value   = data.customerPhone || '';
  document.getElementById('customerAddress').value = data.customerAddress || '';
  document.getElementById('dateDisplay').innerText = currentDate;
  renderChips();
  renderTotals();
}

// â”€â”€ Core functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addPrice() {
  const value = parseFloat(priceInput.value);
  if (isNaN(value) || value <= 0) {
    priceInput.classList.add('shake');
    setTimeout(() => priceInput.classList.remove('shake'), 400);
    return;
  }
  items.push(value);
  total = Math.round((total + value) * 100) / 100;
  priceInput.value = '';
  priceInput.focus();
  updateUI();
  bumpTotal();
}

function removeItem(index) {
  const val = items[index];
  items.splice(index, 1);
  total = Math.round((total - val) * 100) / 100;
  if (total < 0) total = 0;
  updateUI();
}

function newCustomer() {
  if (items.length > 0 && !confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯ØŸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ.')) return;
  // Save current before clearing
  if (document.getElementById('customerName').value.trim() || items.length > 0) {
    saveLocal();
  }
  items = []; total = 0;
  activeIndex = -1;
  document.getElementById('customerName').value    = '';
  document.getElementById('customerPhone').value   = '';
  document.getElementById('customerAddress').value = '';
  currentDate = new Date().toLocaleDateString('ar-IQ');
  document.getElementById('dateDisplay').innerText = currentDate;
  todaySelect.value = '';
  renderChips();
  renderTotals();
  showToast('ØªÙ… Ø¨Ø¯Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯');
}

function renderTotals() {
  totalEl.innerText  = total.toLocaleString('ar-IQ');
  countEl.innerText  = items.length;
}

function renderChips() {
  listEl.innerHTML = '';
  items.forEach((val, i) => {
    const chip = document.createElement('span');
    chip.className = 'item-chip';
    chip.innerHTML = `
      <button class="chip-remove" onclick="removeItem(${i})" title="Ø­Ø°Ù">âœ•</button>
      ${val.toLocaleString('ar-IQ')}
    `;
    listEl.appendChild(chip);
  });
}

function updateUI() {
  renderTotals();
  renderChips();
  saveLocal();
}

function bumpTotal() {
  totalEl.classList.add('bump');
  setTimeout(() => totalEl.classList.remove('bump'), 350);
}

// â”€â”€ Persistence (archive) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveLocal() {
  const name = document.getElementById('customerName').value.trim();
  const customerData = {
    customerName:    document.getElementById('customerName').value,
    customerPhone:   document.getElementById('customerPhone').value,
    customerAddress: document.getElementById('customerAddress').value,
    items: [...items],
    total,
    date: currentDate
  };

  const archive = getArchive();
  if (!archive[todayKey]) archive[todayKey] = [];

  if (activeIndex >= 0 && activeIndex < archive[todayKey].length) {
    archive[todayKey][activeIndex] = customerData;
  } else {
    archive[todayKey].push(customerData);
    activeIndex = archive[todayKey].length - 1;
  }

  saveArchive(archive);
  refreshDropdown();
}

// â”€â”€ Dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshDropdown() {
  const list = getTodayList();
  const prev = todaySelect.value;
  todaySelect.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø²Ø¨ÙˆÙ† â€”</option>';
  list.forEach((c, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = c.customerName
      ? `${c.customerName} â€” ${c.total.toLocaleString('ar-IQ')}`
      : `Ø²Ø¨ÙˆÙ† ${i + 1} â€” ${c.total.toLocaleString('ar-IQ')}`;
    todaySelect.appendChild(opt);
  });
  // Restore selection
  if (activeIndex >= 0) {
    todaySelect.value = activeIndex;
  } else {
    todaySelect.value = prev || '';
  }
}

function loadFromDropdown() {
  const idx = parseInt(todaySelect.value);
  if (isNaN(idx)) return;
  const list = getTodayList();
  if (!list[idx]) return;
  activeIndex = idx;
  applyCustomerData(list[idx]);
  showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ† âœ“');
}

// â”€â”€ Export / Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportJSON() {
  const archive = getArchive();
  if (!Object.keys(archive).length) { showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  const blob = new Blob([JSON.stringify(archive, null, 2)], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  const name = document.getElementById('customerName').value || 'Ø£Ø±Ø´ÙŠÙ';
  link.download = `${name}_${todayKey}.json`;
  link.click();
  showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù âœ“');
}

function importJSON() {
  document.getElementById('fileInput').click();
}

document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const parsed = JSON.parse(ev.target.result);
      // Support both archive format and old single-record format
      let archive = getArchive();
      if (parsed[todayKey] || Object.keys(parsed).some(k => /^\d{4}-\d{2}-\d{2}$/.test(k))) {
        // It's an archive format â€” merge
        Object.keys(parsed).forEach(k => {
          archive[k] = parsed[k];
        });
      } else if (parsed.items !== undefined) {
        // Old single-record format
        if (!archive[todayKey]) archive[todayKey] = [];
        archive[todayKey].push(parsed);
      }
      saveArchive(archive);
      initLoad();
      showToast('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ“');
    } catch(err) { showToast('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'); }
  };
  reader.readAsText(file);
  e.target.value = '';
});

function clearAll() {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) return;
  items = []; total = 0; activeIndex = -1;
  document.getElementById('customerName').value    = '';
  document.getElementById('customerPhone').value   = '';
  document.getElementById('customerAddress').value = '';
  try { localStorage.removeItem('salesArchive'); } catch(e) {}
  renderChips();
  renderTotals();
  refreshDropdown();
  showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// â”€â”€ PWA: Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}

// â”€â”€ PWA: Install prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let deferredPrompt;
const banner = document.getElementById('install-banner');

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  banner.classList.add('visible');
});

document.getElementById('install-btn').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  if (outcome === 'accepted') showToast('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ“');
  deferredPrompt = null;
  banner.classList.remove('visible');
});

document.getElementById('dismiss-banner').addEventListener('click', () => {
  banner.classList.remove('visible');
});

window.addEventListener('appinstalled', () => {
  banner.classList.remove('visible');
  showToast('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ“');
});

// â”€â”€ Shake animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const style = document.createElement('style');
style.textContent = `
  @keyframes shake {
    0%,100%{transform:translateX(0)}
    20%{transform:translateX(-6px)}
    40%{transform:translateX(6px)}
    60%{transform:translateX(-4px)}
    80%{transform:translateX(4px)}
  }
  .shake { animation: shake .35s ease; border-color: #C0392B !important; }
`;
document.head.appendChild(style);

// â”€â”€ Auto-save on change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('customerName').addEventListener('input', saveLocal);
document.getElementById('customerPhone').addEventListener('input', saveLocal);
document.getElementById('customerAddress').addEventListener('input', saveLocal);
</script>
</body>
</html>
